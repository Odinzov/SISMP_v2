<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Новый календарь</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .calendar-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      grid-auto-rows: 40px;
      border: 1px solid #ccc;
      user-select: none;
    }
    .calendar-grid div {
      border: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    .day-header,
    .hour-label {
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .cell {
      cursor: pointer;
      background-color: #fff;
      transition: background-color 0.2s;
    }
    .cell:hover {
      background-color: var(--hover-color);
    }
    .cell.active {
      background-color: var(--primary-color);
      color: #fff;
    }
    .today {
      background-color: rgba(74, 144, 226, 0.1);
    }
    .controls {
      margin: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>
<header class="header">
  <span class="header-text">Сервис управления заданиями</span>
  <div class="dropdown">
    <i id="menuToggle" class="fas fa-list" style="font-size:2rem;cursor:pointer"></i>
    <nav id="dropdownMenu" class="dropdown-content">
      <a href="index.html" class="dropdown-item">Главная</a>
      <a href="dashboard.html" class="dropdown-item">Аккаунт</a>
      <a href="tasks.html" class="dropdown-item">Задачи</a>
      <a href="modern_calendar.html" class="dropdown-item">Календарь</a>
      <a href="profile.html" class="dropdown-item">Профиль</a>
      <a href="tl-dashboard.html" class="dropdown-item">TL Панель</a>
      <a href="risk-log.html" class="dropdown-item">Риски</a>
      <a href="reports.html" class="dropdown-item">Отчёты</a>
    </nav>
  </div>
</header>
<main class="main">
  <section class="info-section">
    <h2>Мои слоты занятости</h2>
    <div class="controls">
      <div>
        <label for="viewMode">Вид:</label>
        <select id="viewMode">
          <option value="week">Неделя</option>
          <option value="day">День</option>
        </select>
      </div>
      <div id="stats"></div>
    </div>
    <div id="calendar" class="calendar-grid"></div>
    <div class="buttons" style="justify-content:center;margin-top:1rem">
      <button class="btn" id="clearBtn">Очистить</button>
      <button class="btn" id="saveBtn">Сохранить</button>
    </div>
  </section>
</main>
<script src="scripts.js"></script>
<script src="sample_data.js"></script>
<script>
  const API = '/api';
  const tokenKey = 'pyToken';
  const days = ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
  const startHour = 8;
  const endHour = 22;
  const calendar = document.getElementById('calendar');
  const stats = document.getElementById('stats');
  const selected = new Set();
  SAMPLE_SLOTS.forEach(s => selected.add(`${s.day}-${s.hour}`));
  let drag = false;
  let dragState = false;
  let view = 'week';

  function buildGrid() {
    calendar.innerHTML = '';
    const today = new Date().getDay();
    const dayIndices = view === 'day'
      ? [today === 0 ? 6 : today - 1]
      : [0,1,2,3,4,5,6];
    calendar.style.gridTemplateColumns = `60px repeat(${dayIndices.length}, 1fr)`;
    // header row
    calendar.appendChild(document.createElement('div'));
    dayIndices.forEach(i => {
      const h = document.createElement('div');
      h.textContent = days[i];
      h.className = 'day-header';
      if (today === (i+1)%7) h.classList.add('today');
      calendar.appendChild(h);
    });
    for (let hour=startHour; hour<=endHour; hour++) {
      const label = document.createElement('div');
      label.textContent = (hour<10?'0':'')+hour+':00';
      label.className = 'hour-label';
      calendar.appendChild(label);
      dayIndices.forEach(d => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.day = d;
        cell.dataset.hour = hour;
        const key = `${d}-${hour}`;
        if (selected.has(key)) cell.classList.add('active');
        calendar.appendChild(cell);
      });
    }
  }

  function updateStats() {
    stats.textContent = `Выбрано часов: ${selected.size}`;
  }

  function toggleCell(el, val) {
    const key = `${el.dataset.day}-${el.dataset.hour}`;
    if (val) {
      el.classList.add('active');
      selected.add(key);
    } else {
      el.classList.remove('active');
      selected.delete(key);
    }
  }

  calendar.addEventListener('mousedown', e => {
    if (e.target.classList.contains('cell')) {
      drag = true;
      dragState = !e.target.classList.contains('active');
      toggleCell(e.target, dragState);
      e.preventDefault();
    }
  });
  calendar.addEventListener('mouseover', e => {
    if (drag && e.target.classList.contains('cell')) {
      toggleCell(e.target, dragState);
    }
  });
  document.addEventListener('mouseup', () => { if (drag) { drag=false; updateStats(); } });
  calendar.addEventListener('click', e => {
    if (e.target.classList.contains('cell')) {
      const nowActive = !e.target.classList.contains('active');
      toggleCell(e.target, nowActive);
      updateStats();
    }
  });

  document.getElementById('clearBtn').onclick = () => {
    selected.clear();
    calendar.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
    updateStats();
  };

  document.getElementById('saveBtn').onclick = () => {
    const slots = Array.from(selected).map(k => {
      const [day, hour] = k.split('-').map(Number);
      return { day, hour };
    });
    fetch(API + '/slots', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem(tokenKey)
      },
      body: JSON.stringify({ slots })
    }).then(r => {
      if(!r.ok) alert('Ошибка сохранения');
    });
  };

  document.getElementById('viewMode').onchange = e => {
    view = e.target.value;
    buildGrid();
  };

  buildGrid();
  updateStats();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
</body>
</html>
