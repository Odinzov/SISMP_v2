<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Редактор задачи</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<header class="header">
  <span class="header-text">Редактирование задачи</span>
  <div class="dropdown">
    <i id="menuToggle" class="fas fa-bars menu-icon"></i>
    <nav id="dropdownMenu" class="dropdown-content">
      <a href="index.html" class="dropdown-item">Главная</a>
      <a href="dashboard.html" class="dropdown-item">Аккаунт</a>
      <a href="tasks.html" class="dropdown-item">Задачи</a>
      <a href="modern_calendar.html" class="dropdown-item">Календарь</a>
      <a href="profile.html" class="dropdown-item">Профиль</a>
      <a href="tl-dashboard.html" class="dropdown-item teacher-link">TL Панель</a>
      <a href="risk-log.html" class="dropdown-item teacher-link">Риски</a>
      <a href="reports.html" class="dropdown-item teacher-link">Отчёты</a>
      <a href="#" id="splitBtn" class="dropdown-item">Разбить на под-задачи</a>
    </nav>
  </div>
</header>
<main class="main">
  <section class="info-section narrow">
    <label>Часы</label>
    <input id="effort" type="number" class="form-input">
    <label>Дедлайн</label>
    <input id="deadline" type="date" class="form-input">
    <label>Приоритет</label>
    <input id="priority" type="text" class="form-input">
    <label>Описание</label>
    <textarea id="description" class="form-input"></textarea>
    <div class="buttons center mt-1">
      <button id="saveBtn" class="btn">Сохранить</button>
    </div>
  </section>
</main>
<script src="scripts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script>
const API='/api', tokenKey='pyToken';
const id=parseInt(new URLSearchParams(location.search).get('id'));
function load(){
  fetch(API+`/tasks/${id}`,{headers:{'Authorization':'Bearer '+localStorage.getItem(tokenKey)}})
    .then(r=>r.json()).then(d=>{
      document.getElementById('effort').value=d.effort||0;
      document.getElementById('priority').value=d.priority||'';
      document.getElementById('description').value=d.description||'';
      if(d.deadline) document.getElementById('deadline').value=d.deadline.split('T')[0];
    });
}
function save(){
  const body={
    effort:parseInt(document.getElementById('effort').value||0),
    deadline:document.getElementById('deadline').value,
    priority:document.getElementById('priority').value.trim(),
    description:document.getElementById('description').value.trim()
  };
  fetch(API+`/tasks/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem(tokenKey)},body:JSON.stringify(body)})
    .then(()=>location.replace('tl-dashboard.html'));
}
if(!localStorage.getItem(tokenKey)) location.replace('login.html');
function splitTasks(){
  const names=prompt('Названия под-задач через запятую:');
  if(!names) return;
  const list=names.split(',').map(s=>s.trim()).filter(Boolean);
  const token=localStorage.getItem(tokenKey);
  Promise.all(list.map(n=>fetch(API+'/tasks',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({name:n,parent_id:id})
  })) ).then(()=>location.reload());
}
document.addEventListener('DOMContentLoaded',()=>{
  load();
  document.getElementById('saveBtn').onclick=save;
  const btn=document.getElementById('splitBtn');
  if(btn) btn.onclick=splitTasks;
});
</script>
</body>
</html>
