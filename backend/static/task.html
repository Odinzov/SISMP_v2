<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Детали задачи</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<header class="header">
  <span class="header-text">Сервис управления заданиями</span>
  <div class="dropdown">
    <i id="menuToggle" class="fas fa-list" style="font-size:2rem;cursor:pointer"></i>
    <nav id="dropdownMenu" class="dropdown-content">
      <a href="index.html" class="dropdown-item">Главная</a>
      <a href="tasks.html" class="dropdown-item">Задачи</a>
      <a href="schedule.html" class="dropdown-item">Календарь</a>
    </nav>
  </div>
</header>
<main class="main">
  <section class="info-section" id="info">
    <h2 id="taskName">Задача</h2>
    <p>Трудоёмкость: <span id="taskEffort"></span></p>
    <p>Дедлайн: <span id="taskDeadline"></span></p>
    <p>Приоритет: <span id="taskPriority"></span></p>
    <p id="taskDescription"></p>
    <div style="margin:1rem 0">
      <label>Прогресс: <span id="progVal">0</span>%</label>
      <input type="range" id="progress" min="0" max="100" value="0" style="width:100%">
      <button class="btn" id="saveBtn" style="margin-top:0.5rem">Сохранить</button>
      <button class="btn" id="doneBtn" style="margin-top:0.5rem">Готово</button>
    </div>
  </section>
  <section class="info-section">
    <h3>Комментарии</h3>
    <ul id="comments" style="list-style:none;padding:0"></ul>
    <textarea id="commentText" style="width:100%;height:60px"></textarea>
    <button class="btn" id="commentBtn" style="margin-top:0.5rem">Отправить</button>
  </section>
</main>
<script src="scripts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@4/build/cjs/index.js"></script>
<script>
const API='/api', tokenKey='pyToken';
const params=new URLSearchParams(location.search);
const taskId=parseInt(params.get('id'));
let currentUser=null;
function load(){
  fetch(API+`/tasks/${taskId}`,{headers:{'Authorization':'Bearer '+localStorage.getItem(tokenKey)}})
    .then(r=>r.json()).then(show);
}
function show(d){
  document.getElementById('taskName').textContent=d.name;
  document.getElementById('taskEffort').textContent=d.effort;
  document.getElementById('taskDeadline').textContent=d.deadline?d.deadline.split('T')[0]:'';
  document.getElementById('taskPriority').textContent=d.priority;
  document.getElementById('taskDescription').textContent=d.description||'';
  document.getElementById('progress').value=d.progress;
  document.getElementById('progVal').textContent=d.progress;
  if(d.progress>=100 || d.status==='pending_review' || d.status==='done'){
    document.getElementById('progress').disabled=true;
    document.getElementById('saveBtn').disabled=true;
    document.getElementById('doneBtn').disabled=true;
  }else{
    document.getElementById('progress').disabled=false;
    document.getElementById('saveBtn').disabled=false;
    document.getElementById('doneBtn').disabled=false;
  }
  const list=document.getElementById('comments');
  list.innerHTML='';
  d.comments.forEach(c=>{
    const li=document.createElement('li');
    li.textContent=`${c.user}: ${c.text}`;
    list.appendChild(li);
  });
}
function saveProgress(){
  const val=document.getElementById('progress').value;
  fetch(API+`/tasks/${taskId}`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem(tokenKey)},
    body:JSON.stringify({progress:val})
  }).then(()=>load());
}
function markDone(){
  fetch(API+`/tasks/${taskId}`,{
    method:'PATCH',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem(tokenKey)},
    body:JSON.stringify({progress:100})
  }).then(()=>load());
}
function addComment(){
  const text=document.getElementById('commentText').value.trim();
  if(!text) return;
  fetch(API+`/tasks/${taskId}/comment`,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem(tokenKey)},
    body:JSON.stringify({text})
  }).then(()=>{document.getElementById('commentText').value='';load();});
}
document.addEventListener('DOMContentLoaded',()=>{
  if(!localStorage.getItem(tokenKey)) location.replace('login.html');
  currentUser=jwt_decode(localStorage.getItem(tokenKey)).uid;
  load();
  document.getElementById('progress').oninput=e=>document.getElementById('progVal').textContent=e.target.value;
  document.getElementById('saveBtn').onclick=saveProgress;
  document.getElementById('doneBtn').onclick=markDone;
  document.getElementById('commentBtn').onclick=addComment;
});
</script>
</body>
</html>
