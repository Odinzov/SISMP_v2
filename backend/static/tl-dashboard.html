<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Панель тимлида</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
<header class="header">
  <span class="header-text">Панель тимлида</span>
  <div class="dropdown">
    <i id="menuToggle" class="fas fa-bars menu-icon"></i>
    <nav id="dropdownMenu" class="dropdown-content">
      <a href="index.html" class="dropdown-item">Главная</a>
      <a href="dashboard.html" class="dropdown-item">Аккаунт</a>
      <a href="tasks.html" class="dropdown-item">Задачи</a>
      <a href="modern_calendar.html" class="dropdown-item">Календарь</a>
      <a href="profile.html" class="dropdown-item">Профиль</a>
      <a href="tl-dashboard.html" class="dropdown-item teacher-link">TL Панель</a>
      <a href="risk-log.html" class="dropdown-item teacher-link">Риски</a>
      <a href="reports.html" class="dropdown-item teacher-link">Отчёты</a>
    </nav>
  </div>
</header>
<main class="main">
  <section class="info-section">
    <h2>Все задачи</h2>
    <label>Фильтр:
      <select id="filterSel">
        <option value="all">Все</option>
        <option value="risk">Риск</option>
        <option value="overdue">Просрочено</option>
      </select>
    </label>
    <table id="dashTable" class="table mt-1">
      <thead>
        <tr>
          <th>ID</th>
          <th>Название</th>
          <th>Прогресс</th>
          <th>Дедлайн</th>
          <th>Приоритет</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:1rem" id="kpi"></div>
  </section>
</main>
<script src="scripts.js"></script>
<script src="sample_data.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script>
const API='/api', tokenKey='pyToken';
const tbody=document.querySelector('#dashTable tbody');
function load(){
  fetch(API+'/tasks',{headers:{'Authorization':'Bearer '+localStorage.getItem(tokenKey)}})
    .then(r=>r.json())
    .then(data=>{if(!Array.isArray(data)||!data.length)data=SAMPLE_TASKS;show(data);})
    .catch(()=>show(SAMPLE_TASKS));
}
function highlightTask(id){
  const row=[...tbody.children].find(r=>r.firstElementChild.textContent==id);
  if(row) row.classList.add('alert-row');
}
function storeAlert(ev){
  const arr=JSON.parse(localStorage.getItem('unseenAlerts')||'[]');
  arr.push(ev); localStorage.setItem('unseenAlerts',JSON.stringify(arr));
}
function highlightStored(){
  const arr=JSON.parse(localStorage.getItem('unseenAlerts')||'[]');
  arr.forEach(ev=>highlightTask(ev.task));
  if(arr.length) localStorage.removeItem('unseenAlerts');
}

function show(list){
  const f=document.getElementById('filterSel').value;
  const now=new Date();
  let risk=0,over=0,diff=0,count=0;
  tbody.innerHTML='';
  list.forEach(t=>{
    const deadline=t.deadline?new Date(t.deadline):null;
    const isOver=deadline && deadline<now && t.progress<100;
    const isRisk=t.progress<50 && deadline && (deadline-now)/86400000<=2;
    if(isRisk) risk++; if(isOver) over++;
    diff+=t.effort-(t.effort*(t.progress||0)/100);
    count++;
    if(f==='risk' && !isRisk) return;
    if(f==='overdue' && !isOver) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.id}</td><td>${t.name}</td><td>${t.progress}%</td>`+
      `<td>${deadline?deadline.toISOString().split('T')[0]:''}</td>`+
      `<td>${t.priority}</td>`+
      `<td><a href="/task/edit/${t.id}">Редактировать</a></td>`;
    tbody.appendChild(tr);
  });
  const avg=count? (diff/count).toFixed(1):0;
  document.getElementById('kpi').textContent=`Рисков: ${risk} | Просрочено: ${over} | Ср. отклонение: ${avg}`;
  highlightStored();
}

document.getElementById('filterSel').onchange=load;
if(!localStorage.getItem(tokenKey)) location.replace('login.html');
function connect(){
  const es=new EventSource(`${API}/risk-stream?token=${localStorage.getItem(tokenKey)}`);
  es.onmessage=e=>{
    const ev=JSON.parse(e.data);
    highlightTask(ev.task);
    storeAlert(ev);
    alert(`Риск: задача ${ev.task} - ${ev.message}`);
  };
}
document.addEventListener('DOMContentLoaded',()=>{load();connect();});
</script>
</body>
</html>
